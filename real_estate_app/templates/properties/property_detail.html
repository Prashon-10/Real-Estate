{% extends 'base.html' %}

{% block title %}{{ property.title }} - RealEstate{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'index' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'properties:property_list' %}">Properties</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ property.title }}</li>
    </ol>
</nav>

<div class="row">
    <div class="col-lg-8">
        <!-- Property Images -->
        <div class="card shadow mb-4">
            <div class="card-body p-0">
                {% if property.images.exists %}
                    <div id="propertyCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-indicators">
                            {% for image in property.images.all %}
                                <button type="button" data-bs-target="#propertyCarousel" data-bs-slide-to="{{ forloop.counter0 }}" class="{% if forloop.first %}active{% endif %}" aria-current="{% if forloop.first %}true{% endif %}" aria-label="Slide {{ forloop.counter }}"></button>
                            {% endfor %}
                        </div>
                        <div class="carousel-inner">
                            {% for image in property.images.all %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img src="{{ image.image.url }}" class="d-block w-100" alt="Property Image {{ forloop.counter }}" style="max-height: 500px; object-fit: cover;">
                                </div>
                            {% endfor %}
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                {% else %}
                    <div class="text-center py-5 bg-light">
                        <i class="fas fa-home fa-4x text-muted mb-3"></i>
                        <p class="mb-0">No images available for this property</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Property Details -->
        <div class="card shadow mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">{{ property.title }}</h4>
                <span class="badge {% if property.status == 'available' %}bg-success{% elif property.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                    {{ property.get_status_display }}
                </span>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <p class="text-muted mb-2"><i class="fas fa-map-marker-alt me-2"></i>{{ property.address }}</p>
                    <h3 class="text-primary">Rs. {{ property.price|floatformat:0 }}</h3>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="feature-item text-center p-3 border rounded">
                            <i class="fas fa-bed fa-2x mb-2 text-primary"></i>
                            <h5>{{ property.bedrooms }}</h5>
                            <p class="mb-0 text-muted">Bedrooms</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-item text-center p-3 border rounded">
                            <i class="fas fa-bath fa-2x mb-2 text-primary"></i>
                            <h5>{{ property.bathrooms }}</h5>
                            <p class="mb-0 text-muted">Bathrooms</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="feature-item text-center p-3 border rounded">
                            <i class="fas fa-ruler-combined fa-2x mb-2 text-primary"></i>
                            <h5>{{ property.square_footage }}</h5>
                            <p class="mb-0 text-muted">Square Feet</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5>Description</h5>
                    <p>{{ property.description|linebreaks }}</p>
                </div>
                
                <div class="alert alert-info">
                    <p class="mb-0"><i class="fas fa-info-circle me-2"></i> Payments are done via bank transfers; this is a real-estate platform, not an e-commerce site.</p>
                </div>
            </div>
        </div>

        <!-- Chat Section (only for customers and agent) -->
{% if user.is_authenticated and property.status == 'available' %}
<div class="card shadow mb-4">
    <div class="card-header bg-white py-3">
        <h5 class="card-title mb-0">
            <i class="fas fa-comments me-2 text-primary"></i>
            Message Exchange
        </h5>
    </div>
    <div class="card-body">
        <!-- Messages -->
        <div class="chat-container mb-3">
            {% for msg in property.messages.all|dictsort:"timestamp" %}
                <div class="mb-2 p-2 border rounded {% if msg.sender == user %}bg-light text-end{% else %}bg-white{% endif %}">
                    <strong>{{ msg.sender.get_full_name|default:msg.sender.username }}</strong><br>
                    {{ msg.content }}
                    <small class="text-muted d-block mt-1">{{ msg.timestamp|date:"M j, Y g:i A" }}</small>
                </div>
            {% empty %}
                <p class="text-muted">No messages yet.</p>
            {% endfor %}
        </div>

        <!-- Message Form -->
        <form method="post" action="{% url 'properties:send_message' property.id %}">
            {% csrf_token %}
            <div class="input-group">
                <input type="text" name="message" class="form-control" placeholder="Type your message..." required>
                <button class="btn btn-primary" type="submit">Send</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
    
    <div class="col-lg-4">
        <!-- Agent Info Card -->
        <div class="card shadow mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">Listing Agent</h5>
            </div>
            <div class="card-body text-center">
                <div class="profile-circle mx-auto mb-3" style="width: 100px; height: 100px;">
                    {% if property.agent.profile_image %}
                        <img src="{{ property.agent.profile_image.url }}" alt="{{ property.agent.username }}">
                    {% else %}
                        <span style="font-size: 2rem;">{{ property.agent.username|make_list|first|upper }}</span>
                    {% endif %}
                </div>
                <h5>{{ property.agent.get_full_name|default:property.agent.username }}</h5>
                <p class="text-muted mb-3">{{ property.agent.get_user_type_display }}</p>
                
                {% if property.agent.phone_number %}
                    <p><i class="fas fa-phone me-2"></i>{{ property.agent.phone_number }}</p>
                {% endif %}
                
                {% if property.agent.email %}
                    <p><i class="fas fa-envelope me-2"></i>{{ property.agent.email }}</p>
                {% endif %}
                
                {% if property.agent.bio %}
                    <div class="text-start mt-3">
                        <h6>About me:</h6>
                        <p class="small">{{ property.agent.bio|truncatewords:30 }}</p>
                    </div>
                {% endif %}
                
                {% if user.is_authenticated and user.is_customer and property.status == 'available' %}
                    <div class="d-grid mt-3">
                        <button class="btn btn-primary" onclick="scrollToChat()">
                            <i class="fas fa-comment me-2"></i> Chat with Agent
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <!-- For customers: favorite button -->
                {% if user.is_authenticated and user.is_customer %}
                    <div class="d-grid gap-2 mb-3">
                        {% if has_booking %}
                            <!-- User has already booked this property -->
                            <div class="btn btn-success disabled" style="opacity: 0.7; cursor: not-allowed; pointer-events: none;">
                                <i class="fas fa-check-circle me-2"></i>Already Booked
                            </div>
                            <div class="btn btn-info disabled" style="opacity: 0.7; cursor: not-allowed; pointer-events: none;">
                                <i class="fas fa-check-circle me-2"></i>Visit Requested
                            </div>
                        {% else %}
                            <!-- Normal booking buttons -->
                            <a href="{% url 'properties:property_booking' property.id %}?type=booking" class="btn btn-success">
                                <i class="fas fa-calendar-plus me-2"></i>Book Property
                            </a>
                            <a href="{% url 'properties:property_booking' property.id %}?type=visit" class="btn btn-info">
                                <i class="fas fa-eye me-2"></i>Request Visit
                            </a>
                        {% endif %}
                        <button class="btn {% if is_favorite %}btn-danger{% else %}btn-outline-danger{% endif %} favorite-toggle" data-property-id="{{ property.id }}">
                            <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart me-2"></i>
                            {% if is_favorite %}Remove from{% else %}Add to{% endif %} Favorites
                        </button>
                    </div>
                {% endif %}
                
                <!-- For agents: edit/delete/status update buttons -->
                {% if user.is_authenticated and user == property.agent %}
                    <div class="d-grid gap-2">
                        <a href="{% url 'properties:property_update' property.id %}" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i> Edit Property
                        </a>
                        <div class="btn-group mt-2 w-100">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                Change Status
                            </button>
                            <ul class="dropdown-menu w-100">
                                <li><a class="dropdown-item status-change" data-status="available" href="#">Mark as Available</a></li>
                                <li><a class="dropdown-item status-change" data-status="pending" href="#">Mark as Pending</a></li>
                                <li><a class="dropdown-item status-change" data-status="sold" href="#">Mark as Sold</a></li>
                            </ul>
                        </div>
                        <a href="{% url 'properties:property_delete' property.id %}" class="btn btn-outline-danger mt-2">
                            <i class="fas fa-trash me-2"></i> Delete Property
                        </a>
                    </div>
                {% endif %}
                
                <!-- Share Buttons -->
                <hr>
                <h6 class="text-center mb-3">Share this property:</h6>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-outline-primary btn-sm mx-1" onclick="shareOnFacebook()">
                        <i class="fab fa-facebook"></i>
                    </button>
                    <button class="btn btn-outline-primary btn-sm mx-1" onclick="shareOnTwitter()">
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="btn btn-outline-success btn-sm mx-1" onclick="shareOnWhatsapp()">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm mx-1" onclick="copyLink()">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Similar Properties -->
        <div class="card shadow">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">Similar Properties</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="similarProperties">
                    <!-- Similar properties will be loaded here -->
                    <div class="text-center py-4 text-muted">
                        <p>Loading similar properties...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Utility functions
    function copyLink() {
        navigator.clipboard.writeText(window.location.href);
        showToast('Link copied to clipboard!', 'success');
    }
    
    function scrollToChat() {
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) {
            chatContainer.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('messageInput').focus();
        }
    }

    function shareOnFacebook() {
        const url = encodeURIComponent(window.location.href);
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
    }

    function shareOnTwitter() {
        const url = encodeURIComponent(window.location.href);
        const text = encodeURIComponent('Check out this property: {{ property.title }}');
        window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
    }

    function shareOnWhatsapp() {
        const url = encodeURIComponent(window.location.href);
        const text = encodeURIComponent('Check out this property: {{ property.title }}');
        window.open(`https://wa.me/?text=${text} ${url}`, '_blank');
    }

    // Document ready function
    document.addEventListener('DOMContentLoaded', function() {
        {% if user.is_authenticated and user.is_customer %}
        // Favorite toggle functionality
        const favoriteButton = document.querySelector('.favorite-toggle');
        
        if (favoriteButton) {
            favoriteButton.addEventListener('click', function() {
                const propertyId = this.dataset.propertyId;
                
                fetch(`/properties/favorite/${propertyId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const icon = this.querySelector('i');
                        if (data.is_favorite) {
                            icon.classList.replace('far', 'fas');
                            this.classList.replace('btn-outline-danger', 'btn-danger');
                            this.innerHTML = `<i class="fas fa-heart me-2"></i> Remove from Favorites`;
                        } else {
                            icon.classList.replace('fas', 'far');
                            this.classList.replace('btn-danger', 'btn-outline-danger');
                            this.innerHTML = `<i class="far fa-heart me-2"></i> Add to Favorites`;
                        }
                        showToast(data.message, data.is_favorite ? 'success' : 'info');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred. Please try again.', 'error');
                });
            });
        }
        {% endif %}

        {% if user.is_authenticated and user == property.agent %}
        // Status change functionality
        const statusButtons = document.querySelectorAll('.status-change');
        
        statusButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const status = this.dataset.status;
                
                if (confirm(`Are you sure you want to mark this property as ${status}?`)) {
                    // Here you would implement an AJAX call to update the property status
                    fetch(`/properties/update-status/{{ property.id }}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ status: status }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast(data.message, 'success');
                            
                            // Update status badge
                            const statusBadge = document.querySelector('.badge');
                            if (statusBadge) {
                                statusBadge.className = 'badge';
                                if (status === 'available') {
                                    statusBadge.classList.add('bg-success');
                                } else if (status === 'pending') {
                                    statusBadge.classList.add('bg-warning');
                                } else {
                                    statusBadge.classList.add('bg-secondary');
                                }
                                statusBadge.textContent = data.status_display;
                            }

                            // If property is marked as sold, hide chat section
                            if (status === 'sold') {
                                const chatSection = document.querySelector('.chat-section');
                                if (chatSection) {
                                    chatSection.style.display = 'none';
                                }
                            }
                        } else {
                            showToast(data.message || 'An error occurred', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred. Please try again.', 'error');
                    });
                }
            });
        });
        {% endif %}

        {% if user.is_authenticated and user.is_customer and property.status == 'available' %}
        // WebSocket chat functionality
        const propertyId = {{ property.id }};
        const userId = {{ user.id }};
        const chatRoomId = {{ chat_room.id|default:0 }};
        
        if (chatRoomId) {
            // Establish WebSocket connection
            const chatSocket = new WebSocket(
                `${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}/ws/chat/${chatRoomId}/`
            );
            
            // Handle received messages
            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                addMessage(data.message, data.sender_id == userId, data.sender_name, data.timestamp);
            };
            
            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };
            
            // Load previous messages
            loadMessages();
            
            // Send message function
            document.getElementById('messageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                if (message) {
                    chatSocket.send(JSON.stringify({
                        'message': message,
                        'sender_id': userId
                    }));
                    messageInput.value = '';
                }
            });
        }
        
        // Helper functions for chat
        function loadMessages() {
            if (!chatRoomId) return;
            
            fetch(`/chat/messages/${chatRoomId}/`)
                .then(response => response.json())
                .then(data => {
                    const messagesList = document.getElementById('messagesList');
                    messagesList.innerHTML = '';
                    
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            addMessage(msg.content, msg.is_mine, msg.sender_name, msg.timestamp);
                        });
                    } else {
                        messagesList.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-comments fa-2x mb-3"></i>
                                <p>Start a conversation with the agent about this property.</p>
                            </div>
                        `;
                    }
                    
                    scrollToBottom();
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                });
        }
        
        function addMessage(content, isMine, sender, timestamp) {
            const messagesList = document.getElementById('messagesList');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isMine ? 'message-sent' : 'message-received'}`;
            
            messageDiv.innerHTML = `
                <div>
                    ${!isMine ? `<strong>${sender}</strong><br>` : ''}
                    ${content}
                    <div class="message-time">${formatTime(timestamp)}</div>
                </div>
            `;
            
            messagesList.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        {% endif %}
        
        // Load similar properties
        loadSimilarProperties();
        
        function loadSimilarProperties() {
            fetch(`/properties/similar/{{ property.id }}/`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('similarProperties');
                    
                    if (data.properties && data.properties.length > 0) {
                        container.innerHTML = '';
                        
                        data.properties.forEach(prop => {
                            container.innerHTML += `
                                <a href="/properties/${prop.id}/" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">${prop.title}</h6>
                                        <small class="text-primary">$${prop.price.toLocaleString()}</small>
                                    </div>
                                    <p class="mb-1 text-muted small">${prop.address}</p>
                                    <small>
                                        <i class="fas fa-bed me-1"></i>${prop.bedrooms}
                                        <i class="fas fa-bath mx-1"></i>${prop.bathrooms}
                                    </small>
                                </a>
                            `;
                        });
                    } else {
                        container.innerHTML = `
                            <div class="text-center py-4 text-muted">
                                <p>No similar properties found</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading similar properties:', error);
                    document.getElementById('similarProperties').innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <p>Error loading similar properties</p>
                        </div>
                    `;
                });
        }
    });
</script>
{% endblock %}